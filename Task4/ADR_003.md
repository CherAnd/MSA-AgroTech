# ADR-003: Управление животноводством.

---

## 1. Функциональные требования


| **№** | **Описание**                                                                                                                                                                                                   |
|:-----:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  F1   | фиксировать признаки беспокойного поведения или драк среди животных и оповещать оператора                                                                                                                      |
|  F2   | фиксировать признаки задавливания поросят                                                                                                                                                                      |
|  F3   | управлять кормушками и поилками разных производителей                                                                                                                                                          |
|  F4   | оценивать состояние животных по внешнему виду и поведению:<br/>болезнь, гибель, беспокойство и так далее                                                                                                       |
|  F5   | следить за состоянием систем фильтрации воды                                                                                                                                                                   |
|  F6   | пересчитывать поголовье, делать пересчёт животных                                                                                                                                                              |
|  F7   | следить за запасами еды и прогнозировать расход                                                                                                                                                                |
|  U1   | оповещать оператора о событиях                                                                                                                                                                                 |
|  P1   | поддерживать необходимое количество видеокамер для аналитики в реальном времени от разных производителей                                                                                                       |
|  P2   | работать даже в случае отсутствия интернета и при необходимости отправлять уведомления дежурному сотруднику<br/> на местах мониторинга, а после восстановления связи синхронизироваться с центральной системой |
|  S1   | быть построена по принципу «центральный сервер — агенты» на конкретных фермах без ограничения количества<br/>таких агентов                                                                                     |
|  S2   | иметь разделение ролей и поддерживать современные способы аутентификации и авторизации                                                                                                                         |
|  S3   | предоставлять базовые метрики для передачи в другие системы                                                                                                                                                    |
|  S4   | поддерживать возможность добавления собственных метрик                                                                                                                                                         |
|  S5   | иметь API для создания мобильного приложения или веб-приложения                                                                                                                                                |
|  R1   | в синхронизации между агентами и центральным сервером допускается задержка до 10 минут без учёта проблем со связью                                                                                             |
|  R2   | на ферме нестабильный WiFi, поэтому нужно продумать альтернативные каналы связи                                                                                                                                |
|  R3   | покрытие камерами всей площади — нужно по максимуму убрать слепые зоны либо воспользоваться камерами типа «рыбий глаз», но это снизит качество в силу выпуклости линзы                                         |
|  R4   | на каждой ферме допустимо использовать один центральный сервер и необходимый набор edge-устройств                                                                                                              |


#### Верхнеуровневые Use Cases.

| **№** | **Действующие лица или системы** | **Use Case**                                                                                                                                                     | **Описание**                                                                                                                                                                                                                                                                                                                                                                                | **Комментарий**                |
|:-----:|:---------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|  UC1  | оператор, платформа              | Оповещение оператора о:<br/>- беспокойство животных;<br/>- драка животных;<br/>- гибель животного                                                                | 1. Система фиксирует одно из событий, приведённых в use case.<br/>2. Система отправляет сообщение о событии на местный АРМ дежурному сотруднику и центральную систему.<br/> 3. В случае отсутствия связи с центральной системой, сообщение должно быть передано после восстановления связи.<br/>4. Дежурный оператор квитирует получение сообщения.                                         | Требования: F1, F2, F4, U1, P2 |
|  UC2  | оператор, платформа              | Предоставление метрик и отчётов о:<br/>- состояние систем фильтрации;<br/>- поголовье животных;<br/>- оценка состояния животных;<br/>- пользовательская метрика; | 1. Оператор регистрируется в системе в начале смены<br/>2. Оператор запрашивает систему о требуемой метрике<br/>3. Система формирует отчёт с требуемыми метриками в нужной оператору форме                                                                                                                                                                                                  | Требования: F4, F6, F7         |
|  UC3  | платформа                        | Кормление и поение животных                                                                                                                                      | 1. Система отслеживает наличие и уровень воды и корма.<br/>2. Система выдаёт животным порции корма и воды в соответствии с требованиями животновода.<br/>3. При достижении нижней уставки уровня запасов корма, система формирует заявку на пополнение запасов корма.<br/>4. При приближении истечения срока эксплуатации водяного фильтра, система формирует заявку на обновления фильтра. | Требования: F3, F5, F7         |
|  UC4  | платформа, оператор              | Приплод                                                                                                                                                          | 1. Система делает пересчёт животных.<br/>2. Система обнаруживат новорожденного.<br/>3. Система оповещает оператора и животновода о приплоде.                                                                                                                                                                                                                                                | Требования: F6, U1             |


### Нефункциональные требования
Опишите здесь нефункциональные требования и архитектурно значимые требования.

| **№** | **Требование**                                                                                                                                                                     |
|:-----:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|   1   | обеспечивать достаточно высокую отказоустойчивость 99,95%                                                                                                                          |
|   2   | быть расширяемой, то есть иметь возможность разработать новый функционал без изменений существующего                                                                               |
|   3   | иметь высокую производительность — от момента возникновения нештатной ситуации, зафиксированной с помощью видеоаналитики, должно проходить не более 5 секунд до момента оповещения |
|   4   | позволять системе видеоаналитики реагировать в реальном времени (миллисекунды)                                                                                                     |

## 2. Решение

### Описание
Архитектура построена по принципу «центральный сервер — агенты».
Агент (система управления фермой) сделан автономным полноценной работы при отсутствии связи с центральной системой. 

Сервисы работающие нейросетевыми моделями (Сервис анализа поведения животных и сервис подсчёта поголовья) входят в состав локальной системы.

Сервисы питания и кормления из состава АСУФ отвечают за выполнение задач по кормлпению и поению животных. Задания создаётся животноводом удалённо и корректируется в реальном времени по показаниям датчиков. 

Агент имеет web-интерфейс для управления фермой. Управляет фермой оператор. В случае отстствия связи с центральной системой оператор на ферме имеет возмоность изменять параметры работы согластно устным приказам от животновода.

Центральная система управления животноводством собирает данные со всех агентов (ферм) для аналитики и прогнозирования запасов и расходов, а также централизованного заказа кормов и расходных материалов (например фильтров для воды)



Представлено два варианта архитектуры:


Вариант 1</br> 
[Context diagram](../Task1/C1_Вариант1.puml), [Container diagram](../Task2/C2_Вариант1.puml), [Component diagram](../Task3/C3_Вариант1.puml), [Classes diagram](../Task3/C4_Вариант1.puml)</br>
Вариант 2 </br>
[Context diagram](../Task1/C1_Вариант2.puml), [Container diagram](../Task2/C2_Вариант2.puml), [Component diagram](../Task3/C3_Вариант2.puml), [Classes diagram](../Task3/C4_Вариант2.puml)

### Аргументация

| Критерий                 | Вариант 1</br>(набор микросервисов с локальной репликой kafka)                        | Вариант 2<br/> (готовая SCADA-система)                                                                                                                                   |
|--------------------------|------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Надежность               | Сообщения хранятся в kafka и гарантируется их доставка                     | все данные хранятся штатными средвтсвами SACADA, требуется гарантия доставки сигналов до SCADA                                                                                                          |
| Масштабируемость         | Масштабируемость заложена изначально в виде микросервисов                | Возможно потребуется дополнительных усилий для увеличения мощностей                                                                                    |
| Разработка, тестирования | Разработчики используют известные им инструменты, каждый компонент может быть оттестировать независимо | Требует знакомство с архитектурой SCADA. Создаёт трудности при архитектурных схемах, не предусмотренных разработчиком SCADA |


### 3. Выводы

Предпочтительней выбрать вариант 1 с локальной репликой kafka и синхронизацией с синхронизацией центральной системой. 
Данный вариант лучше подходит для реализации полноценной системы.

Второй вариант подходит для быстрого создания MVP и развития до систем среднего масштаба.